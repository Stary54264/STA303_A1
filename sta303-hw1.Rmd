---
title: "sta303-hw1"
output: html_document
date: "2025-02-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
library(MASS)  
library(ggplot2)
library(here)
load(here::here("data/Portugal.RData"))
install.packages("kableExtra", repos = "https://cloud.r-project.org/")



```

```{r}
portugal

summary(portugal)


table(portugal$literacy)
table(portugal$ageMarried)



library(dplyr)
library(knitr)
library(kableExtra)



numerical_summary <- portugal %>%
  select(where(is.numeric)) %>%
  summarise(
    across(
      everything(),
      list(
        Mean = ~ mean(.x, na.rm = TRUE),
        SD = ~ sd(.x, na.rm = TRUE),
        Min = ~ min(.x, na.rm = TRUE),
        Max = ~ max(.x, na.rm = TRUE)
      )
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = c("Variable", ".value"),
    names_sep = "_"
  )


categorical_summary <- portugal %>%
  select(where(is.factor)) %>%
  summarise(
    across(
      everything(),
      ~ paste(names(table(.x)), "(", table(.x), ")", collapse = "\n")
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Variable",
    values_to = "Summary"
  )


numerical_summary %>%
  kbl(caption = "Numerical Summary Table for Dataset 'portugal'", align = "l") %>%
  kableExtra::kable_styling(full_width = FALSE, position = "center") %>%
  kableExtra::column_spec(3, width = "20em") 


categorical_summary %>%
  kbl(caption = "Categorical Summary Table for Dataset 'portugal'", align = "l") %>%
  kableExtra::kable_styling(full_width = FALSE, position = "center") %>%
  kableExtra::column_spec(2, width = "30em") 






```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
# Bar plot of ageMarried categories
library(ggplot2)
library(tidyverse)
ggplot(portugal, aes(x = ageMarried)) +
  geom_bar(fill = "red") +
  theme_minimal() +
  labs(title = "Distribution of Age Married", x = "Age Married", y = "Count")

# Boxplot of children by literacy(categorical variable)
ggplot(portugal, aes(x = literacy, y = children)) +
  geom_boxplot(fill = "blue") +
  theme_minimal() +
  labs(title = "Number of Children by Literacy", x = "Literacy", y = "Children")



# Scatterplot with Regression Line
ggplot(portugal, aes(x = age, y = children, color = literacy)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  theme_minimal() +
  labs(title = "Relationship between Age and Number of Children",
       x = "Age",
       y = "Number of Children",
       color = "Literacy")


ggplot(portugal, aes(x = ageMarried, y = children, fill = literacy)) +
  geom_bar(stat = "summary", fun = "mean", position = "dodge") +
  facet_wrap(~region) +
  theme_minimal() +
  labs(title = "Average Number of Children by Age Married and Literacy",
       x = "Age Married",
       y = "Average Number of Children",
       fill = "Literacy")


ggplot(portugal, aes(x = pregnancies, fill = literacy)) +
  geom_histogram(aes(y = ..density..), binwidth = 1, color = "yellow", alpha = 0.6) +
  geom_density(alpha = 0.4) +
  theme_minimal() +
  labs(title = "Distribution of Number of Pregnancies by Literacy",
       x = "Number of Pregnancies",
       y = "Density",
       fill = "Literacy")


ggplot(portugal, aes(x = ageMarried, y = children, fill = literacy)) +
  geom_violin(trim = FALSE, scale = "width", alpha = 0.7) +
  geom_jitter(shape = 1, color = "black", width = 0.2, alpha = 0.6) +
  theme_minimal() +
  labs(title = "Distribution of Number of Children by Age Married and Literacy",
       x = "Age Married",
       y = "Number of Children",
       fill = "Literacy")

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r}
portugal$logYearsMarried = log(pmax(1, portugal$monthsSinceM)/12)
#set reference-"18to20"
portugal$ageMarried = relevel(portugal$ageMarried, "18to20")

poi_model = glm(children ~offset(logYearsMarried) + literacy + ageMarried, data = portugal, family = poisson)

knitr::kable(summary(poi_model)$coef, digits = 3)



library(dplyr)
library(knitr)


model_summary <- summary(poi_model)


coef_summary <- as.data.frame(model_summary$coefficients)


colnames(coef_summary) <- c("Estimate", "Std. Error", "z value", "Pr(>|z|)")


knitr::kable(coef_summary, caption = "Summary Table for Model: poi_model", digits = 3, align = "c") %>%
  kableExtra::kable_styling(full_width = FALSE, position = "center") %>%
  kableExtra::column_spec(1, bold = TRUE) 



```



```{r}
poi_modelCI = as.data.frame(exp(confint(poi_model)[-1,]))
poi_modelCI$level = gsub(paste(names(poi_model$xlevels), collapse='|'),
   "", rownames(poi_modelCI))
poi_modelCI$variable=unlist(strsplit(rownames(poi_modelCI),poi_modelCI$level))
poi_modelCI$x = 1:nrow(poi_modelCI)
poi_modelCI$cex = sqrt(1/apply(log(poi_modelCI[,1:2]),1,diff))
forXaxis = tapply(poi_modelCI$x, poi_modelCI$variable, mean)

poi_modelCI[1:3,]
```
```{r}
matplot(poi_modelCI[,1:2], type='n',
   xaxt='n', bty='n', xaxt='n',
   log='y', ylab='RR')

segments(poi_modelCI$x, poi_modelCI[,1],
   poi_modelCI$x, poi_modelCI[,2])


numeric_coef <- as.numeric(as.character(poi_modelCI$coef[-1]))
numeric_coef <- rep(0, length(poi_modelCI$x))  # Ensure the same length

 points(poi_modelCI$x,
   exp(numeric_coef), pch=15,
   cex = poi_modelCI$cex, col = '#00000030')
 

 
mtext(poi_modelCI$level, 1, at=poi_modelCI$x,
   las=3, line=-1)

mtext(names(forXaxis), 1, at=forXaxis,
   line=-2)
abline(h=1, lty=3)

mtext(poi_modelCI$level, side = 1, at = poi_modelCI$x, las = 1, line = 3, cex = 0.5)
```



```{r}
#install.packages("TMB", type = "source")
#packageVersion("TMB")
#packageVersion("Matrix")
#.rs.restartR()

library('glmmTMB')
NB_model = glmmTMB(children ~ offset(logYearsMarried) + literacy +
   ageMarried, data = portugal,family=nbinom2)



NB_model_summary <- summary(NB_model)


nb_coef_summary <- as.data.frame(NB_model_summary$coefficients$cond)


colnames(nb_coef_summary) <- c("Estimate", "Std. Error", "z value", "Pr(>|z|)")

æ ¼
knitr::kable(nb_coef_summary, caption = "Summary Table for Model: NB_model", digits = 3, align = "c") %>%
  kableExtra::kable_styling(full_width = FALSE, position = "center") %>%
  kableExtra::column_spec(1, bold = TRUE) 

```



```{r}
knitr::kable(
   rbind(confint(NB_model)[1:7,c(3,1,2)],
 sd=1/sqrt(confint(NB_model, parm='sigma'))[c(3,2,1)]), digits=3)
```


```{r}
NB_modelFitCI = as.data.frame(exp(confint(NB_model)[-1,]))
NB_modelFitCI$level = gsub(paste(names(NB_model$xlevels), collapse='|'),
   "", rownames(NB_modelFitCI))
NB_modelFitCI$variable=unlist(strsplit(rownames(NB_modelFitCI),NB_modelFitCI$level))
NB_modelFitCI$x = 1:nrow(NB_modelFitCI)
NB_modelFitCI$cex = sqrt(1/apply(log(NB_modelFitCI[,1:2]),1,diff))
forXaxis = tapply(NB_modelFitCI$x, NB_modelFitCI$variable, mean)

NB_modelFitCI[1:3,]
```

```{r}

```

```{r}
exp(confint(NB_model, 1))
1/sqrt(confint(NB_model, parm = "sigma"))
```

