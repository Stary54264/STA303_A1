---
title: "sta303-hw1"
output: html_document
date: "2025-02-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
library(MASS)  
library(ggplot2)
library(here)
load(here::here("data/Portugal.RData"))


```

```{r}
portugal

summary(portugal)


table(portugal$literacy)
table(portugal$ageMarried)


# 加载必要的库
library(knitr)
library(dplyr)




numeric_summary <- portugal %>%
  select_if(is.numeric) %>%
  summarise_all(list(
    Min = ~min(., na.rm = TRUE),
    Median = ~median(., na.rm = TRUE),
    Mean = ~mean(., na.rm = TRUE),
    Max = ~max(., na.rm = TRUE),
    SD = ~sd(., na.rm = TRUE)
  )) %>%
  pivot_longer(cols = everything(),
               names_to = c("Variable", ".value"),
               names_sep = "_")


categorical_summary <- portugal %>%
  select_if(~is.factor(.) || is.character(.)) %>%
  summarise_all(~list(table(.))) %>%
  pivot_longer(cols = everything(),
               names_to = "Variable",
               values_to = "Frequency")


cat("Summary of Numeric Variables:\n")
kable(numeric_summary, caption = "Summary of  Numeric Variables", digits = 3)

cat("Summary of Categorical Variables:\n")
for (i in seq_along(categorical_summary$Variable)) {
  cat(paste0("\nVariable: ", categorical_summary$Variable[i], "\n"))
  print(categorical_summary$Frequency[[i]])
}







```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
# Bar plot of ageMarried categories
library(ggplot2)
library(tidyverse)
ggplot(portugal, aes(x = ageMarried)) +
  geom_bar(fill = "red") +
  theme_minimal() +
  labs(title = "Distribution of Age Married", x = "Age Married", y = "Count")

# Boxplot of children by literacy(categorical variable)
ggplot(portugal, aes(x = literacy, y = children)) +
  geom_boxplot(fill = "blue") +
  theme_minimal() +
  labs(title = "Number of Children by Literacy", x = "Literacy", y = "Children")



# Scatterplot with Regression Line
ggplot(portugal, aes(x = age, y = children, color = literacy)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  theme_minimal() +
  labs(title = "Relationship between Age and Number of Children",
       x = "Age",
       y = "Number of Children",
       color = "Literacy")


ggplot(portugal, aes(x = ageMarried, y = children, fill = literacy)) +
  geom_bar(stat = "summary", fun = "mean", position = "dodge") +
  facet_wrap(~region) +
  theme_minimal() +
  labs(title = "Average Number of Children by Age Married and Literacy",
       x = "Age Married",
       y = "Average Number of Children",
       fill = "Literacy")


ggplot(portugal, aes(x = pregnancies, fill = literacy)) +
  geom_histogram(aes(y = ..density..), binwidth = 1, color = "yellow", alpha = 0.6) +
  geom_density(alpha = 0.4) +
  theme_minimal() +
  labs(title = "Distribution of Number of Pregnancies by Literacy",
       x = "Number of Pregnancies",
       y = "Density",
       fill = "Literacy")


ggplot(portugal, aes(x = ageMarried, y = children, fill = literacy)) +
  geom_violin(trim = FALSE, scale = "width", alpha = 0.7) +
  geom_jitter(shape = 1, color = "black", width = 0.2, alpha = 0.6) +
  theme_minimal() +
  labs(title = "Distribution of Number of Children by Age Married and Literacy",
       x = "Age Married",
       y = "Number of Children",
       fill = "Literacy")

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r}
portugal$logYearsMarried = log(pmax(1, portugal$monthsSinceM)/12)
#set reference-"18to20"
portugal$ageMarried = relevel(portugal$ageMarried, "18to20")

model1 = glm(children ~offset(logYearsMarried) + literacy + ageMarried, data = portugal, family = poisson)

knitr::kable(summary(model1)$coef, digits = 3)
```



```{r}
model1CI = as.data.frame(exp(confint(model1)[-1,]))
model1CI$level = gsub(paste(names(model1$xlevels), collapse='|'),
   "", rownames(model1CI))
model1CI$variable=unlist(strsplit(rownames(model1CI),model1CI$level))
model1CI$x = 1:nrow(model1CI)
model1CI$cex = sqrt(1/apply(log(model1CI[,1:2]),1,diff))
forXaxis = tapply(model1CI$x, model1CI$variable, mean)

model1CI[1:3,]
```
```{r}
matplot(model1CI[,1:2], type='n',
   xaxt='n', bty='n', xaxt='n',
   log='y', ylab='RR')

segments(model1CI$x, model1CI[,1],
   model1CI$x, model1CI[,2])


numeric_coef <- as.numeric(as.character(model1CI$coef[-1]))
numeric_coef <- rep(0, length(model1CI$x))  # Ensure the same length

 points(model1CI$x,
   exp(numeric_coef), pch=15,
   cex = model1CI$cex, col = '#00000030')
 

 
mtext(model1CI$level, 1, at=model1CI$x,
   las=3, line=-1)

mtext(names(forXaxis), 1, at=forXaxis,
   line=-2)
abline(h=1, lty=3)

mtext(model1CI$level, side = 1, at = model1CI$x, las = 1, line = 3, cex = 0.5)
```



```{r}
#install.packages("TMB", type = "source")
#packageVersion("TMB")
#packageVersion("Matrix")
#.rs.restartR()

library('glmmTMB')
model2 = glmmTMB(children ~ offset(logYearsMarried) + literacy +
   ageMarried, data = portugal,family=nbinom2)
```

```{r}
knitr::kable(
   rbind(confint(model2)[1:7,c(3,1,2)],
 sd=1/sqrt(confint(model2, parm='sigma'))[c(3,2,1)]), digits=3)
```


```{r}
model2FitCI = as.data.frame(exp(confint(model2)[-1,]))
model2FitCI$level = gsub(paste(names(model2$xlevels), collapse='|'),
   "", rownames(model2FitCI))
model2FitCI$variable=unlist(strsplit(rownames(model2FitCI),model2FitCI$level))
model2FitCI$x = 1:nrow(model2FitCI)
model2FitCI$cex = sqrt(1/apply(log(model2FitCI[,1:2]),1,diff))
forXaxis = tapply(model2FitCI$x, model2FitCI$variable, mean)

model2FitCI[1:3,]
```

```{r}

```

```{r}
exp(confint(model2, 1))
1/sqrt(confint(model2, parm = "sigma"))
```

