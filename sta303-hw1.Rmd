---
title: "sta303-hw1"
output: html_document
date: "2025-02-06"
---
t
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
library(MASS)  
library(ggplot2)
load("portugal.RData")


```

```{r}
portugal

summary(portugal)


table(portugal$literacy)
table(portugal$ageMarried)


```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
# Bar plot of ageMarried categories
library(ggplot2)
library(tidyverse)
ggplot(portugal, aes(x = ageMarried)) +
  geom_bar(fill = "red") +
  theme_minimal() +
  labs(title = "Distribution of Age Married", x = "Age Married", y = "Count")

# Boxplot of children by literacy(categorical variable)
ggplot(portugal, aes(x = literacy, y = children)) +
  geom_boxplot(fill = "blue") +
  theme_minimal() +
  labs(title = "Number of Children by Literacy", x = "Literacy", y = "Children")



# Scatterplot with Regression Line
ggplot(portugal, aes(x = age, y = children, color = literacy)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  theme_minimal() +
  labs(title = "Relationship between Age and Number of Children",
       x = "Age",
       y = "Number of Children",
       color = "Literacy")


ggplot(portugal, aes(x = ageMarried, y = children, fill = literacy)) +
  geom_bar(stat = "summary", fun = "mean", position = "dodge") +
  facet_wrap(~region) +
  theme_minimal() +
  labs(title = "Average Number of Children by Age Married and Literacy",
       x = "Age Married",
       y = "Average Number of Children",
       fill = "Literacy")


ggplot(portugal, aes(x = pregnancies, fill = literacy)) +
  geom_histogram(aes(y = ..density..), binwidth = 1, color = "yellow", alpha = 0.6) +
  geom_density(alpha = 0.4) +
  theme_minimal() +
  labs(title = "Distribution of Number of Pregnancies by Literacy",
       x = "Number of Pregnancies",
       y = "Density",
       fill = "Literacy")


ggplot(portugal, aes(x = ageMarried, y = children, fill = literacy)) +
  geom_violin(trim = FALSE, scale = "width", alpha = 0.7) +
  geom_jitter(shape = 1, color = "black", width = 0.2, alpha = 0.6) +
  theme_minimal() +
  labs(title = "Distribution of Number of Children by Age Married and Literacy",
       x = "Age Married",
       y = "Number of Children",
       fill = "Literacy")

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r}
portugal$logYearsMarried = log(pmax(1, portugal$monthsSinceM)/12)
#set reference-"18to20"
portugal$ageMarried = relevel(portugal$ageMarried, "18to20")

model1 = glm(children ~offset(logYearsMarried) + literacy + ageMarried, data = portugal, family = poisson)

knitr::kable(summary(model1)$coef, digits = 3)
```



```{r}
model1CI = as.data.frame(exp(confint(model1)[-1,]))
model1CI$level = gsub(paste(names(model1$xlevels), collapse='|'),
   "", rownames(model1CI))
model1CI$variable=unlist(strsplit(rownames(model1CI),model1CI$level))
model1CI$x = 1:nrow(model1CI)
model1CI$cex = sqrt(1/apply(log(model1CI[,1:2]),1,diff))
forXaxis = tapply(model1CI$x, model1CI$variable, mean)

model1CI[1:3,]
```
```{r}
matplot(model1CI[,1:2], type='n',
   xaxt='n', bty='n', xaxt='n',
   log='y', ylab='RR')

segments(model1CI$x, model1CI[,1],
   model1CI$x, model1CI[,2])


numeric_coef <- as.numeric(as.character(model1CI$coef[-1]))
numeric_coef <- rep(0, length(model1CI$x))  # Ensure the same length

 points(model1CI$x,
   exp(numeric_coef), pch=15,
   cex = model1CI$cex, col = '#00000030')
 

 
mtext(model1CI$level, 1, at=model1CI$x,
   las=3, line=-1)

mtext(names(forXaxis), 1, at=forXaxis,
   line=-2)
abline(h=1, lty=3)
```



```{r}
#install.packages("TMB", type = "source")
#packageVersion("TMB")
#packageVersion("Matrix")
#.rs.restartR()

library('glmmTMB')
model2 = glmmTMB(children ~ offset(logYearsMarried) + literacy +
   ageMarried, data = portugal,family=nbinom2)
```

```{r}
knitr::kable(
   rbind(confint(model2)[1:7,c(3,1,2)],
 sd=1/sqrt(confint(model2, parm='sigma'))[c(3,1,2)]), digits=3)
```


```{r}
model2FitCI = as.data.frame(exp(confint(model2)[-1,]))
model2FitCI$level = gsub(paste(names(model2$xlevels), collapse='|'),
   "", rownames(model2FitCI))
model2FitCI$variable=unlist(strsplit(rownames(model2FitCI),model2FitCI$level))
model2FitCI$x = 1:nrow(model2FitCI)
model2FitCI$cex = sqrt(1/apply(log(model2FitCI[,1:2]),1,diff))
forXaxis = tapply(model2FitCI$x, model2FitCI$variable, mean)

model2FitCI[1:3,]
```

```{r}
matplot(model2FitCI[,1:2], type='n',
   xaxt='n', bty='n', xaxt='n',
   log='y', ylab='RR')

segments(model2FitCI$x, model2FitCI[,1],
   model2FitCI$x, model2FitCI[,2])

points(model2FitCI$x,
   exp(model1$coef[-1]), pch=15,
   cex = model2FitCI$cex, col = '#00000030')

mtext(model2FitCI$level, 1, at=model1CI$x,
   las=3, line=-1)

mtext(names(forXaxis), 1, at=forXaxis,
   line=-2)
 abline(h=1, lty=3)
 
 
 mtext(names(forXaxis), 1, at=forXaxis,
   line=-2)
 abline(h=1, lty=3)
 
# 调整绘图边距以避免标签重叠
par(mar = c(12, 4, 4, 2) + 0.1)  # 增加底部边距

# 修改x轴标签的显示方式
mtext(
  model2FitCI$level,  # 原标签
  side = 1,           # 放置在x轴
  at = model2FitCI$x, # 对应的x轴位置
  las = 2,            # 标签旋转为垂直
  line = 5,           # 调整标签与坐标轴的距离
  cex = 0.6           # 缩小字体大小，避免过于拥挤
)

# 添加标题（可选）
title(main = "Adjusted Relative Risks", cex.main = 1.2)  # 增加标题和字体大小

```

```{r}
exp(confint(model2, 1))
1/sqrt(confint(model2, parm = "sigma"))
```

